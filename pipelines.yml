apiVersion: v1.1
resources:
  - name: gitfklogger
    type: GitRepo
    configuration:
      gitProvider: github_geoffwilliams               # Change to your integration
      path: declarativesystems/fklogger
pipelines:
  - name:   fklogger
    configuration:
      runtime:
        type: image
        image:
          # see https://www.jfrog.com/confluence/display/JFROG/Runtime+Images#RuntimeImages-Go

          # custom image
          # https://www.jfrog.com/confluence/display/JFROG/Choosing+your+Runtime+Image
          image:
            custom:
              name: "declarativesystems.jfrog.io/docker/docker-local/nodejs"
              tag: 0.0.0-0
              #options: "-e HOME=/root"
              registry: Artifactory            # if custom image is private, an integration is required for authentication
              sourceRepository: docker-local       # required if registry is Artifactory. e.g. docker-local

#          auto:
#            language: node
#            versions:
#              - "12.14.0"
#                "declarativesystems.jfrog.io/docker/docker-local:0.0.0-0"
    steps:
      - name: build
        type: NpmBuild
        configuration:
          # ohhhhhhhh this is the repository to READ artifacts from ffs
          npmArgs: "--verbose"
          repositoryName: npm
          sourceLocation: .
          integrations:
            - name: Artifactory
          inputResources:
            - name: gitfklogger

        execution:
#          onStart:
#            - echo "Upgrading nodeJS..."
#            - export NVM_DIR="$HOME/.nvm"
#            - ' [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  # This loads nvm'
## breaks everything
#            - nvm install 15.0.1
#            - node --version
          onSuccess:
            - echo "[✓] build"
          onFailure:
            - echo "[✖] build"
            - echo "try to find build logs:"
            - find / -iname build_logs
          onComplete:                                  #always
            - echo "Build environment info:"
            - pushd $res_gitfklogger_resourcePath
            - npm run-script info



      - name: test
        type: Bash
        configuration:
          inputResources:
            - name: gitfklogger
          inputSteps:
            - name: build
        execution:
          onStart:
            - pushd $res_gitfklogger_resourcePath
            - make test

      - name: publish
        type: NpmPublish
        configuration:
          repositoryName:      npm-local    # required, npm repository name on artifactory
          integrations:
            - name:        Artifactory
          inputSteps:
            - name:         test               # required
        execution:
          onStart:
            - echo "exporting build step name (vital)"
            - export inputNpmBuildStepName="build"
          onSuccess:
            - echo "[✓] publish"
          onFailure:
            - echo "[✖] publish"
